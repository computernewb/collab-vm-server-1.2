name: CollabVM Server

on: [push, pull_request]

jobs:
  windows_x64: # Windows Server 2019 (x64)
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v1
      # - name: LETS TAKE A LOOK AT NUMBER 4
        # id: msys-runtime
        # shell: cmd
        # run: |
          # mkdir cvmlib
          # cd cvmlib
          # echo getting pacman-6.0.1-9-x86_64.pkg.tar.zst
          # C:\\msys64\\usr\\bin\\wget.exe https://mirror.msys2.org/msys/x86_64/pacman-6.0.1-9-x86_64.pkg.tar.zst
          # C:\\msys64\\usr\\bin\\zstd.exe -d pacman-6.0.1-9-x86_64.pkg.tar.zst
          # C:\\msys64\\usr\\bin\\bsdtar.exe -xf pacman-6.0.1-9-x86_64.pkg.tar          
          # echo getting msys2-runtime-3.3.3-4-x86_64.pkg.tar
          # C:\\msys64\\usr\\bin\\wget.exe https://mirror.msys2.org/msys/x86_64/msys2-runtime-3.3.3-4-x86_64.pkg.tar.zst
          # C:\\msys64\\usr\\bin\\zstd.exe -d msys2-runtime-3.3.3-4-x86_64.pkg.tar.zst
          # C:\\msys64\\usr\\bin\\bsdtar.exe -xf msys2-runtime-3.3.3-4-x86_64.pkg.tar
          # cd usr/bin
          # echo copying binarys
          # rem this sucks but we can't use *
          # copy msys-2.0.dll C:\\msys64\\usr\\bin /Y
          # copy pacman.exe C:\\msys64\\usr\\bin /Y
          # copy pacman-conf.exe C:\\msys64\\usr\\bin /Y
          # copy testpkg.exe C:\\msys64\\usr\\bin /Y
      - name: Install CLANG64 Env
        id: depends
        shell: C:\\msys64\\usr\\bin\\env.exe -i /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: | 
          pacman -S mingw-w64-clang-x86_64-cmake mingw-w64-clang-x86_64-clang mingw-w64-clang-x86_64-make --noconfirm
      - name: Build dependancies
        id: buildd
        shell: bash
        run: |
          mkdir build
          echo "PATH=/c/msys64/clang64/bin:/c/msys64/mingw64/bin:$PATH" >> $GITHUB_ENV
          export CC=C:\\msys64\\clang64\\bin\\clang.exe
          export CXX=C:\\msys64\\clang64\\bin\\clang++.exe
          C:\\msys64\\clang64\\bin\\cmake -B build -G"MSYS Makefiles" -DCMAKE_TOOLCHAIN_FILE=C:\\vcpkg\\scripts\\buildsystems\\vcpkg.cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_MAKE_PROGRAM="mingw32-make" -DCMAKE_C_FLAGS="-DBOOST_ASIO_HAS_STD_INVOKE_RESULT" -DCMAKE_CXX_FLAGS="-DBOOST_ASIO_HAS_STD_INVOKE_RESULT"
      - name: Build server
        id: build
        shell: bash
        run: |
          echo "PATH=$PATH:C:\\msys64\\clang64\\bin" >> $GITHUB_ENV
          export CC=C:\\msys64\\clang64\\bin\\clang.exe
          export CXX=C:\\msys64\\clang64\\bin\\clang++.exe
          cd build
          cmake --build .
          
  ubuntu_x64: # Latest version of Ubuntu
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
        with: 
          submodules: true
      - name: Install Dependencies
        id: depends
        run: | 
          mkdir build
          sudo apt install -y libvncserver-dev libboost-dev libboost-system-dev libboost-filesystem-dev libboost-program-options-dev libspdlog-dev libfmt-dev cmake ninja-build
      - name: Install latest LLVM/Clang
        id: llvm
        run: |
          # We need the latest version of Clang to build the server.
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 13
      - name: Build
        id: build
        run: |
          # Use clang instead of GCC
          export CC=/usr/bin/clang-13
          export CXX=/usr/bin/clang++-13
          cmake -B build -GNinja -DCMAKE_BUILD_TYPE=Release
          cd build
          cmake --build .
          
  #publish: # Publish the artifacts
  #  name: Publish for ${{ matrix.os }}
  #  runs-on: ${{ matrix.os }}
  #  strategy: 
  #    matrix: 
  #      include:
  #        - os: ubuntu-latest
  #          artifact_name: collab-vm-server
  #          asset_name: collab-vm-server-linux-amd64
  #        - os: windows-2019
  #          artifact_name: collab-vm-server.exe
  #          asset_name: collab-vm-server-windows-amd64.exe  
  #  steps:
  #    - name: Upload binaries for release
  #      uses: svenstaro/upload-release-action@v2
  #      with:
  #        repo_token: ${{ secrets.GITHUB_TOKEN }}
  #        file: build/${{ matrix.artifact_name }}
  #        asset_name: $${ matrix.asset_name }}
  #        tag: ${{ github.ref }}
